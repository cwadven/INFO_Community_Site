{% extends 'formlayout/formlayer.html' %}
{% load post_extras %}
{% block name %}

<script>
$('#exampleModal').on('show.bs.modal', function (event) {
  var button = $(event.relatedTarget) // Button that triggered the modal
  var recipient = button.data('whatever') // Extract info from data-* attributes
  // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
  // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
  var modal = $(this)
  modal.find('.modal-title').text('New message to ' + recipient)
  modal.find('.modal-body input').val(recipient)
})
function image_change(){
  $('#image_modify').val('true');
}

function files_change(){
  $('#files_modify').val('true');
}

function re_comment(x, y){
  var text = document.getElementById(y);
  if (x.checked == true){
    text.style.display="block";
  } else {
    text.style.display="none";
  }
}

function ajax_comment_like(x, y){
  $.ajax({
    // type을 설정합니다.
    type : 'GET',
    url : "{% url 'forms:ajax_comment_like' '00000' %}".replace(/00000/, x),
    success : function (data) {
        // 로그인 사용자 정보가 잘못 되었을 경우
        if(data["count_like"]){
          $('#countlike'+x).text(data["count_like"])
          if(data["like_state"]){
            // 좋아요를 누를 수 있음
            y.innerHTML = '<svg class="svg-icon" viewBox="0 0 20 20"><path d="M9.719,17.073l-6.562-6.51c-0.27-0.268-0.504-0.567-0.696-0.888C1.385,7.89,1.67,5.613,3.155,4.14c0.864-0.856,2.012-1.329,3.233-1.329c1.924,0,3.115,1.12,3.612,1.752c0.499-0.634,1.689-1.752,3.612-1.752c1.221,0,2.369,0.472,3.233,1.329c1.484,1.473,1.771,3.75,0.693,5.537c-0.19,0.32-0.425,0.618-0.695,0.887l-6.562,6.51C10.125,17.229,9.875,17.229,9.719,17.073 M6.388,3.61C5.379,3.61,4.431,4,3.717,4.707C2.495,5.92,2.259,7.794,3.145,9.265c0.158,0.265,0.351,0.51,0.574,0.731L10,16.228l6.281-6.232c0.224-0.221,0.416-0.466,0.573-0.729c0.887-1.472,0.651-3.346-0.571-4.56C15.57,4,14.621,3.61,13.612,3.61c-1.43,0-2.639,0.786-3.268,1.863c-0.154,0.264-0.536,0.264-0.69,0C9.029,4.397,7.82,3.61,6.388,3.61"></path></svg>'
          } else {
            // 좋아요 취소를 누를 수 있음
            y.innerHTML = '<svg class="svg-icon" viewBox="0 0 20 20"><path fill="red" d="M9.719,17.073l-6.562-6.51c-0.27-0.268-0.504-0.567-0.696-0.888C1.385,7.89,1.67,5.613,3.155,4.14c0.864-0.856,2.012-1.329,3.233-1.329c1.924,0,3.115,1.12,3.612,1.752c0.499-0.634,1.689-1.752,3.612-1.752c1.221,0,2.369,0.472,3.233,1.329c1.484,1.473,1.771,3.75,0.693,5.537c-0.19,0.32-0.425,0.618-0.695,0.887l-6.562,6.51C10.125,17.229,9.875,17.229,9.719,17.073 M6.388,3.61C5.379,3.61,4.431,4,3.717,4.707C2.495,5.92,2.259,7.794,3.145,9.265c0.158,0.265,0.351,0.51,0.574,0.731L10,16.228l6.281-6.232c0.224-0.221,0.416-0.466,0.573-0.729c0.887-1.472,0.651-3.346-0.571-4.56C15.57,4,14.621,3.61,13.612,3.61c-1.43,0-2.639,0.786-3.268,1.863c-0.154,0.264-0.536,0.264-0.69,0C9.029,4.397,7.82,3.61,6.388,3.61"></path></svg>'
          }
        }
    },
  });
}

function ajax_board_like(x, y){
  $.ajax({
    // type을 설정합니다.
    type : 'GET',
    url : "{% url 'forms:ajax_board_like' '00000' %}".replace(/00000/, x),
    success : function (data) {
        // 로그인 사용자 정보가 잘못 되었을 경우
        if(data["board_like"]){
          $('#board_like').text(data["board_like"])
          if(data["like_state"]){
            // 좋아요를 누를 수 있음
            y.innerHTML = '<svg class="svg-icon" viewBox="0 0 20 20"><path d="M9.719,17.073l-6.562-6.51c-0.27-0.268-0.504-0.567-0.696-0.888C1.385,7.89,1.67,5.613,3.155,4.14c0.864-0.856,2.012-1.329,3.233-1.329c1.924,0,3.115,1.12,3.612,1.752c0.499-0.634,1.689-1.752,3.612-1.752c1.221,0,2.369,0.472,3.233,1.329c1.484,1.473,1.771,3.75,0.693,5.537c-0.19,0.32-0.425,0.618-0.695,0.887l-6.562,6.51C10.125,17.229,9.875,17.229,9.719,17.073 M6.388,3.61C5.379,3.61,4.431,4,3.717,4.707C2.495,5.92,2.259,7.794,3.145,9.265c0.158,0.265,0.351,0.51,0.574,0.731L10,16.228l6.281-6.232c0.224-0.221,0.416-0.466,0.573-0.729c0.887-1.472,0.651-3.346-0.571-4.56C15.57,4,14.621,3.61,13.612,3.61c-1.43,0-2.639,0.786-3.268,1.863c-0.154,0.264-0.536,0.264-0.69,0C9.029,4.397,7.82,3.61,6.388,3.61"></path></svg>'
          } else {
            // 좋아요 취소를 누를 수 있음
            y.innerHTML = '<svg class="svg-icon" viewBox="0 0 20 20"><path fill="red" d="M9.719,17.073l-6.562-6.51c-0.27-0.268-0.504-0.567-0.696-0.888C1.385,7.89,1.67,5.613,3.155,4.14c0.864-0.856,2.012-1.329,3.233-1.329c1.924,0,3.115,1.12,3.612,1.752c0.499-0.634,1.689-1.752,3.612-1.752c1.221,0,2.369,0.472,3.233,1.329c1.484,1.473,1.771,3.75,0.693,5.537c-0.19,0.32-0.425,0.618-0.695,0.887l-6.562,6.51C10.125,17.229,9.875,17.229,9.719,17.073 M6.388,3.61C5.379,3.61,4.431,4,3.717,4.707C2.495,5.92,2.259,7.794,3.145,9.265c0.158,0.265,0.351,0.51,0.574,0.731L10,16.228l6.281-6.232c0.224-0.221,0.416-0.466,0.573-0.729c0.887-1.472,0.651-3.346-0.571-4.56C15.57,4,14.621,3.61,13.612,3.61c-1.43,0-2.639,0.786-3.268,1.863c-0.154,0.264-0.536,0.264-0.69,0C9.029,4.397,7.82,3.61,6.388,3.61"></path></svg>'
          }
        }
    },
  });
}


function ajax_board_favorite(x, y){
  $.ajax({
    // type을 설정합니다.
    type : 'GET',
    url : "{% url 'forms:ajax_board_favorite' '00000' %}".replace(/00000/, x),
    success : function (data) {
        // 로그인 사용자 정보가 잘못 되었을 경우
        if(data["board_favorite"]){
          // $('#board_favorite').text(data["board_favorite"])
          if(data["like_state"]){
            // 즐겨찾기를 누를 수 있음
            y.innerHTML = '<svg class="svg-icon" viewBox="0 0 20 20"><path d="M17.684,7.925l-5.131-0.67L10.329,2.57c-0.131-0.275-0.527-0.275-0.658,0L7.447,7.255l-5.131,0.67C2.014,7.964,1.892,8.333,2.113,8.54l3.76,3.568L4.924,17.21c-0.056,0.297,0.261,0.525,0.533,0.379L10,15.109l4.543,2.479c0.273,0.153,0.587-0.089,0.533-0.379l-0.949-5.103l3.76-3.568C18.108,8.333,17.986,7.964,17.684,7.925 M13.481,11.723c-0.089,0.083-0.129,0.205-0.105,0.324l0.848,4.547l-4.047-2.208c-0.055-0.03-0.116-0.045-0.176-0.045s-0.122,0.015-0.176,0.045l-4.047,2.208l0.847-4.547c0.023-0.119-0.016-0.241-0.105-0.324L3.162,8.54L7.74,7.941c0.124-0.016,0.229-0.093,0.282-0.203L10,3.568l1.978,4.17c0.053,0.11,0.158,0.187,0.282,0.203l4.578,0.598L13.481,11.723z"></path></svg>'
          } else {
            // 즐겨찾기 취소를 누를 수 있음
            y.innerHTML = '<svg class="svg-icon" viewBox="0 -10 511.98685 511"><path d="m510.652344 185.902344c-3.351563-10.367188-12.546875-17.730469-23.425782-18.710938l-147.773437-13.417968-58.433594-136.769532c-4.308593-10.023437-14.121093-16.511718-25.023437-16.511718s-20.714844 6.488281-25.023438 16.535156l-58.433594 136.746094-147.796874 13.417968c-10.859376 1.003906-20.03125 8.34375-23.402344 18.710938-3.371094 10.367187-.257813 21.738281 7.957031 28.90625l111.699219 97.960937-32.9375 145.089844c-2.410156 10.667969 1.730468 21.695313 10.582031 28.09375 4.757813 3.4375 10.324219 5.1875 15.9375 5.1875 4.839844 0 9.640625-1.304687 13.949219-3.882813l127.46875-76.183593 127.421875 76.183593c9.324219 5.609376 21.078125 5.097657 29.910156-1.304687 8.855469-6.417969 12.992187-17.449219 10.582031-28.09375l-32.9375-145.089844 111.699219-97.941406c8.214844-7.1875 11.351563-18.539063 7.980469-28.925781zm0 0" fill="#ffc107"/></svg>'
          }
        }
    },
  });
}

// 알람 차단 설정
function ajax_donot_alert(x, y){
  $.ajax({
    // type을 설정합니다.
    type : 'GET',
    url : "{% url 'forms:ajax_donot_alert' '00000' %}".replace(/00000/, x),
    success : function (data) {
        // 로그인 사용자 정보가 잘못 되었을 경우
        if(data["board_donotalert"]){
          // $('#board_donotalert').text(data["board_donotalert"])
          if(data["like_state"]){
            // 즐겨찾기를 누를 수 있음
            y.innerHTML = '<svg class="svg-icon" enable-background="new 0 0 511.156 511.156" height="512" viewBox="0 0 511.156 511.156" width="512" xmlns="http://www.w3.org/2000/svg"><path d="m283.532 175.905h-55.908c-17.285 0-31.347-14.063-31.347-31.347v-87.616c0-31.398 25.544-56.942 56.942-56.942h4.719c31.398 0 56.942 25.544 56.942 56.942v87.616c-.001 17.285-14.063 31.347-31.348 31.347z" fill="#186fa2"/><path d="m257.938 0h-2.359v175.905h27.954c17.285 0 31.347-14.063 31.347-31.347v-87.616c-.001-31.398-25.545-56.942-56.942-56.942z" fill="#063651"/><path d="m255.578 511.156c-42.597 0-77.252-34.654-77.252-77.251s34.655-77.252 77.252-77.252 77.251 34.655 77.251 77.252-34.654 77.251-77.251 77.251z" fill="#fbac5b"/><path d="m255.578 356.653v154.503c42.597 0 77.251-34.654 77.251-77.251s-34.654-77.252-77.251-77.252z" fill="#fd8f32"/><path d="m442.747 435.044h-374.338c-7.082 0-13.569-4.776-15.042-11.704-1.458-6.859 1.668-13.629 8.01-16.559 1.505-.976 12.833-8.897 24.174-32.862 20.829-44.01 25.201-106.005 25.201-150.263 0-79.855 64.967-144.82 144.821-144.82 79.665 0 144.512 64.652 144.82 144.245.007.191.011.383.011.575 0 44.258 4.372 106.253 25.201 150.263 11.341 23.965 22.668 31.887 24.174 32.862 6.342 2.93 9.469 9.699 8.01 16.559-1.473 6.927-7.959 11.704-15.042 11.704zm7.2-28.157h.01z" fill="#fddb8d"/><path d="m449.779 406.781c-1.505-.976-12.833-8.897-24.174-32.862-20.829-44.01-25.201-106.005-25.201-150.263 0-.192-.004-.384-.011-.575-.308-79.591-65.153-144.242-144.815-144.245v356.208h187.169c7.082 0 13.569-4.776 15.042-11.704 1.458-6.86-1.668-13.629-8.01-16.559z" fill="#fbac5b"/></svg>'
          } else {
            // 즐겨찾기 취소를 누를 수 있음
            y.innerHTML = '<svg class="svg-icon" enable-background="new 0 0 512 512" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><path d="m450.201 407.453c-1.505-.977-12.832-8.912-24.174-32.917-20.829-44.082-25.201-106.18-25.201-150.511 0-.193-.004-.384-.011-.576-.227-58.589-35.31-109.095-85.514-131.756v-34.657c0-31.45-25.544-57.036-56.942-57.036h-4.719c-31.398 0-56.942 25.586-56.942 57.036v34.655c-50.372 22.734-85.525 73.498-85.525 132.334 0 44.331-4.372 106.428-25.201 150.511-11.341 24.004-22.668 31.939-24.174 32.917-6.342 2.935-9.469 9.715-8.01 16.586 1.473 6.939 7.959 11.723 15.042 11.723h109.947c.614 42.141 35.008 76.238 77.223 76.238s76.609-34.097 77.223-76.238h109.947c7.082 0 13.569-4.784 15.042-11.723 1.457-6.871-1.669-13.652-8.011-16.586zm-223.502-350.417c0-14.881 12.086-26.987 26.942-26.987h4.719c14.856 0 26.942 12.106 26.942 26.987v24.917c-9.468-1.957-19.269-2.987-29.306-2.987-10.034 0-19.832 1.029-29.296 2.984v-24.914zm29.301 424.915c-25.673 0-46.614-20.617-47.223-46.188h94.445c-.608 25.57-21.549 46.188-47.222 46.188zm60.4-76.239c-.003 0-213.385 0-213.385 0 2.595-4.044 5.236-8.623 7.861-13.798 20.104-39.643 30.298-96.129 30.298-167.889 0-63.417 51.509-115.01 114.821-115.01s114.821 51.593 114.821 115.06c0 .185.003.369.01.553.057 71.472 10.25 127.755 30.298 167.286 2.625 5.176 5.267 9.754 7.861 13.798z"/></svg>'
          }
        }
    },
  });
}

function delete_board() {
  var r = confirm("정말로 게시글을 삭제하시겠습니까?");
  if (r == true) {
    location.href = "{% url 'forms:del_form' detail_getForm.category detail_getForm.id %}";
  } else {
    return;
  }
}

function delete_comment(x) {
  var r = confirm("정말로 게시글을 삭제하시겠습니까?");
  if (r == true) {
    location.href = "{% url 'forms:comment_del' detail_getForm.category detail_getForm.id '00000' %}".replace(/00000/, x);
  } else {
    return;
  }
}

</script>
<!-- 알림 설정 -->
{% if user.is_authenticated %}
<p>알림 활성화 : <span onclick="ajax_donot_alert('{{detail_getForm.id}}', this)">{{detail_getForm|board_alert:request.user.username|safe}}</span></p>
{% endif %}
<!-- 제목 -->
<h3>{{detail_getForm.title}}</h3>

<!-- 작성일자 -->
작성일자 : {{detail_getForm.created_at}}<br>

<!-- 작성자 -->
<p>
by : {{detail_getForm.author.Name}}

<!-- 작성자 프로필 사진 -->
{% if detail_getForm.author.Image %}
<img width="50" height="50" src={{detail_getForm.author.Image.url}}>
{% else %}
<img width="50" height="50" src=https://image.flaticon.com/icons/svg/634/634741.svg>
{% endif %}
</p>

<!-- 내용 -->
<p><h3>{{detail_getForm.body}}</h3></p>

<!-- 사진 -->
{% if detail_getForm.image_set.all %}
<p>
<b>이미지 🎨</b><br>
{% for i in detail_getForm.image_set.all %}
<a href="{{i.image.url}}" download>{{i.image.name|slice:"14:"}}</a><br>
{% endfor %}
</p>
{% endif %}

<!-- 첨부파일 -->
{% if detail_getForm.files_set.all %}
<p>
<b>첨부파일 💾</b><br>
{% for i in detail_getForm.files_set.all %}
<a href="{{i.files.url}}" download>{{i.files.name|slice:"11:"}}</a><br>
{% endfor %}
</p>
{% endif %}

<!-- 좋아요 즐겨 찾기 -->
<p>
👍 : <span id="board_like">{{detail_getForm.mylike}}</span>
{% if user.is_authenticated %}
<span onclick="ajax_board_like('{{detail_getForm.id}}', this)">{{detail_getForm|board_checking:request.user.username|safe}}</span>
Favorite : <span onclick="ajax_board_favorite('{{detail_getForm.id}}', this)">{{detail_getForm|board_favorite:request.user.username|safe}}</span>
{% endif %}
</p>

{% if detail_getForm.author.user.username == request.user.username %}
<!-- 수정하기 modal -->
<form enctype="multipart/form-data" action="{% url 'forms:mod_form' detail_getForm.category detail_getForm.id %}" method="post">
    {% csrf_token %}
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">수정하기</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="recipient-name" class="col-form-label">제목 :</label>
              <input name="title" type="text" class="form-control" id="recipient-name" value="{{detail_getForm.title}}" required>
            </div>
            <div class="form-group">
              <label for="message-text" class="col-form-label">내용 :</label>
              <textarea name="body" class="form-control" id="message-text" required>{{detail_getForm.body}}</textarea>
            </div>
            {% for i in detail_getForm.image_set.all %}
            {{i.image.name|slice:"14:"}}<br>
            {% endfor %}
            이미지 : <input onchange="image_change()" type="file" name="image" accept="image/*" multiple><br>
            {% for i in detail_getForm.files_set.all %}
            {{i.files.name|slice:"11:"}}<br>
            {% endfor %}
            첨부파일 : <input onchange="files_change()" type="file" name="files" multiple>
            <input id="image_modify" type="text" name="image_modify" value='' hidden>
            <input id="files_modify" type="text" name="files_modify" value='' hidden>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">수정하기</button>
        </div>
      </div>
    </div>
  </div>
</form>

<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal" data-whatever="@mdo">수정하기</button>
<a style="color:#f83f3f;cursor:pointer;" onclick="delete_board();">삭제하기</a>
{% endif %}
<hr>

<!-- 댓글 작성 -->
{% if user.is_authenticated %}
<form action="{% url 'forms:comment_write' detail_getForm.category detail_getForm.id %}" method="post">
    {% csrf_token %}
    {{ commentform.as_table }}
    <input type="submit" value="댓글달기">
</form>
{% endif %}

<!-- 댓글 내용 -->
{% for comment in detail_getComment %}
<p>
<p>
<div><b>댓글</b> : {{comment.body}}</div>
<div><b>작성자</b> : {{comment.author.Name}} <br>
👍 : <span id="countlike{{comment.id}}">{{comment.mylike}}</span>
{% if user.is_authenticated %}
<span onclick="ajax_comment_like('{{comment.id}}', this)">{{comment|_checking:request.user.username|safe}}</span>
{% endif %}
{% if request.user.username == comment.author.user.username %}
<a style="color:#f83f3f;cursor:pointer;" onclick="delete_comment('{{comment.id}}');">댓글 삭제</a>
{% endif %}
</div>
</p>

<!-- 댓글 대댓글 작성 -->
{% if user.is_authenticated %}
<p><input id="checkBox{{comment.id}}" type="checkbox" name="re_comment" value="답글" onclick="re_comment(this, 're_comment{{comment.id}}')"> 답글달기</p>
<div style="display: none;" id=re_comment{{comment.id}}>
<form action="{% url 'forms:recomment_write' detail_getForm.category detail_getForm.id comment.id %}" method="post">
    {% csrf_token %}
    {{ commentform.as_table }}
    <p><input type="submit" value="댓글달기"></p>
</form>
</div>
{% endif %}

<!-- 댓 대댓글 내용 -->
{% for re_comment in comment.comment_set.all %}
<!-- 대체로 _set은 앞에는 class 이름이다!! -->
<p>
&nbsp;ㄴ<b>답글 내용</b> : {{re_comment.body}}<br>
&nbsp;&nbsp;&nbsp;&nbsp;<b>작성자</b> : {{re_comment.author.Name}}<br>
<!-- 댓 대댓글 좋아요 -->
&nbsp;&nbsp;&nbsp;&nbsp;👍 : <span id="countlike{{re_comment.id}}">{{re_comment.mylike}}</span>
{% if user.is_authenticated %}
<span onclick="ajax_comment_like('{{re_comment.id}}', this)">{{re_comment|_checking:request.user.username|safe}}</span>
{% endif %}
{% if request.user.username == re_comment.author.user.username %}
<a style="color:#f83f3f;cursor:pointer;" onclick="delete_comment('{{re_comment.id}}');">댓글 삭제</a>
{% endif %}
<br>
</p>

{% endfor %}
<hr>

</p>
{% endfor %}


{% endblock %}